#!/usr/bin/env node

var colors = require('colors');
var path = require('path');
var program = require('commander');
var process = require('process');

require('./common/utils.js');

program = attachCommonOptions(program);
program
  .option('--hook-path [path]', 'the route for the hook. defaults to /')
  .parse(process.argv);

generateApp(program, expressTemplate);

function expressTemplate(version, appName, destinationPath, args) {
  // Write package.json
  var deps = {
    'body-parser': '~1.15.0',
    'express': '~4.13.4',
    'express-x-hub': '~1.0.4'
  };
  write(path.join(destinationPath, 'package.json'),
      JSON.stringify(initPkg(version, appName, deps), null, 2) + '\n');

  // Build config file
  var config = {
    'GITHUB_USER': args.ghUser,
    'GITHUB_TOKEN': args.ghToken,
    'HOOK_PATH': args.hookPath ? args.hookPath : '/',
    'HOOK_SECRET': args.hookSecret
  };
  write(path.join(destinationPath, 'config.json'),
      JSON.stringify(config, null, 2) + '\n');

  // Copy boilerplate
  copy(path.join('express', 'hooks.js'), path.join(destinationPath, 'hooks.js'));
  copy(path.join('express', 'index.js'), path.join(destinationPath, 'index.js'));
  copy(path.join('express', 'server.js'), path.join(destinationPath, 'server.js'));

  console.log('SUCCESS!'.green);
}
